<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ResistorVision 2.2 - Mobile First</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #0a0e27;
            color: #e8f4fd;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px 0;
        }

        h1 {
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #00ff88;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .credits {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
        }

        .credits span {
            color: #00ff88;
            font-weight: bold;
        }

        /* Stats */
        .stats {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 0, 255, 0.1);
            border: 1px solid #ff00ff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ff00ff;
        }

        .stat-label {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 10px;
        }

        .tab {
            flex: 1;
            padding: 12px 5px;
            border: none;
            background: transparent;
            color: #fff;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .tab.active {
            background: linear-gradient(45deg, #00ff88, #00ccff);
            color: #0a0e27;
        }

        .tab:not(.active):hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Sections */
        .section {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .section.active {
            display: block;
        }

        /* Upload button */
        .upload-area {
            border: 2px dashed #00ff88;
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            background: rgba(0, 255, 136, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: rgba(0, 255, 136, 0.1);
        }

        .upload-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        /* Canvas para foto */
        #photoCanvas, #trainingCanvas {
            width: 100%;
            height: auto;
            max-width: 100%;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            border: 2px solid #00ff88;
            cursor: crosshair;
        }

        /* Instructions */
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .instructions.active {
            display: block;
        }

        .step {
            padding: 8px 0;
            opacity: 0.6;
        }

        .step.active {
            opacity: 1;
            color: #00ff88;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 8px 0;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00ff88, #00ccff);
            color: #0a0e27;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid #00ff88;
        }

        .btn-learning {
            background: linear-gradient(45deg, #ff00ff, #ff00ff88);
            color: #fff;
        }

        /* Inputs */
        input[type="number"], select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid #ff00ff;
            font-size: 1em;
        }

        /* Result */
        .result {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            border: 2px solid #00ff88;
            text-align: center;
        }

        .result-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 10px;
        }

        /* Manual mode resistor */
        .resistor {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: linear-gradient(90deg, #d4a574, #c19660, #d4a574);
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .band {
            width: 12px;
            height: 60px;
            border-radius: 2px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .band:hover {
            transform: scale(1.1);
        }

        .band.selected {
            border: 2px solid #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }

        /* Color grid */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .color-btn {
            padding: 10px 5px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85em;
            font-weight: 600;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-btn:active {
            transform: scale(0.95);
        }

        .color-btn.selected {
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0,255,136,0.5);
        }

        /* Messages */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 10px;
            z-index: 1000;
            animation: slideDown 0.3s ease;
            font-size: 0.9em;
            min-width: 200px;
            text-align: center;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .toast.success {
            background: rgba(0, 255, 136, 0.9);
            color: #0a0e27;
        }

        .toast.error {
            background: rgba(255, 51, 102, 0.9);
            color: #fff;
        }

        .toast.info {
            background: rgba(0, 204, 255, 0.9);
            color: #0a0e27;
        }

        /* History */
        .history-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 10px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-value {
            font-weight: bold;
            color: #00ff88;
        }

        .history-time {
            font-size: 0.8em;
            opacity: 0.7;
        }

        /* DB Controls */
        .db-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        /* Fix for iOS */
        input[type="file"] {
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 360px) {
            h1 { font-size: 1.5em; }
            .tab { font-size: 0.75em; padding: 10px 3px; }
            .color-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 768px) {
            .container { max-width: 600px; }
            .color-grid { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ResistorVision</h1>
            <div class="subtitle">v2.2 Mobile</div>
            <div class="credits">
                Por <span>ClaudIA</span> y <span>Prof. Sergio</span>
            </div>
        </header>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="patternsCount">0</div>
                <div class="stat-label">Patrones</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="accuracyRate">0%</div>
                <div class="stat-label">Precisi√≥n</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="samplesCount">0</div>
                <div class="stat-label">Muestras</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="openTab('analyze', this)">üîç Analizar</button>
            <button class="tab" onclick="openTab('training', this)">üß† Entrenar</button>
            <button class="tab" onclick="openTab('manual', this)">‚úã Manual</button>
        </div>

        <!-- ANALIZAR -->
        <div id="analyze" class="section active">
            <div id="uploadArea" class="upload-area" onclick="document.getElementById('photoInput').click()">
                <div class="upload-icon">üì∑</div>
                <div>Toca para tomar o seleccionar foto</div>
                <div style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">
                    Coloca la resistencia horizontal con buena luz
                </div>
            </div>
            <input type="file" id="photoInput" accept="image/*" capture="environment">
            
            <canvas id="photoCanvas"></canvas>
            
            <div id="instructions" class="instructions">
                <div class="step" id="s1">üì∏ Foto cargada</div>
                <div class="step" id="s2">üëÜ Toca el centro de cada banda</div>
                <div class="step" id="s3">üìç Marca 3-5 bandas en orden</div>
                <div class="step" id="s4">‚úÖ Presiona Analizar</div>
            </div>
            
            <div id="analyzeControls" style="display: none;">
                <button class="btn btn-primary" id="analyzeBtn" disabled onclick="analyzeResistor()">
                    üéØ Analizar Resistencia
                </button>
                <button class="btn btn-secondary" onclick="resetAnalysis()">
                    üîÑ Nueva Foto
                </button>
            </div>
            
            <div id="analysisResult"></div>
        </div>

        <!-- ENTRENAR -->
        <div id="training" class="section">
            <div style="background: rgba(255,0,255,0.1); padding: 12px; border-radius: 10px; margin-bottom: 15px;">
                üí° Entrena con resistencias de valor conocido
            </div>
            
            <input type="number" id="knownValue" placeholder="Valor (ej: 1000)">
            
            <select id="knownUnit">
                <option value="1">Œ© (Ohms)</option>
                <option value="1000">kŒ© (Kilohms)</option>
                <option value="1000000">MŒ© (Megaohms)</option>
            </select>
            
            <button class="btn btn-learning" onclick="startTraining()">
                üì∏ Tomar Foto para Entrenar
            </button>
            
            <canvas id="trainingCanvas"></canvas>
            
            <div id="trainingControls" style="display: none;">
                <div class="instructions active">
                    <div class="step active">Toca cada banda para entrenar</div>
                </div>
                <button class="btn btn-primary" onclick="saveTraining()" id="saveBtn" disabled>
                    üíæ Guardar Patr√≥n
                </button>
            </div>
            
            <div style="margin-top: 20px;">
                <h4 style="color: #ff00ff; margin-bottom: 10px;">üìä Base de Datos</h4>
                <div id="dbInfo" style="margin-bottom: 10px;">0 patrones guardados</div>
                <div class="db-controls">
                    <button class="btn btn-learning" onclick="exportDB()">üì• Exportar</button>
                    <button class="btn btn-learning" onclick="document.getElementById('importInput').click()">üì§ Importar</button>
                    <input type="file" id="importInput" accept=".json" onchange="importDB(this)">
                </div>
                <button class="btn btn-secondary" onclick="clearDB()">üóëÔ∏è Limpiar BD</button>
            </div>
        </div>

        <!-- MANUAL -->
        <div id="manual" class="section">
            <div class="resistor">
                <div class="band" data-band="1" onclick="selectBand(1)"></div>
                <div class="band" data-band="2" onclick="selectBand(2)"></div>
                <div class="band" data-band="3" onclick="selectBand(3)"></div>
                <div class="band" data-band="4" onclick="selectBand(4)"></div>
                <div class="band" data-band="5" onclick="selectBand(5)"></div>
            </div>
            
            <div id="colorSelector">
                <h4 style="margin-bottom: 10px;">Banda <span id="currentBand">1</span></h4>
                <div class="color-grid" id="colorGrid"></div>
            </div>
            
            <button class="btn btn-primary" onclick="calculateManual()">
                ‚ö° Calcular Valor
            </button>
            
            <div id="manualResult"></div>
        </div>

        <!-- HISTORIAL -->
        <div style="margin-top: 25px;">
            <h3 style="color: #00ff88; margin-bottom: 10px;">üìä Historial</h3>
            <div id="historyList"></div>
            <button class="btn btn-secondary" onclick="clearHistory()" style="margin-top: 10px;">
                üóëÔ∏è Limpiar Historial
            </button>
        </div>
    </div>

    <script>
        // =========================
        // VARIABLES GLOBALES
        // =========================
        const colorCodes = {
            'Negro': { value: 0, multiplier: 1, hex: '#000000', rgb: [0,0,0] },
            'Marr√≥n': { value: 1, multiplier: 10, hex: '#8B4513', rgb: [139,69,19] },
            'Rojo': { value: 2, multiplier: 100, hex: '#FF0000', rgb: [255,0,0] },
            'Naranja': { value: 3, multiplier: 1000, hex: '#FFA500', rgb: [255,165,0] },
            'Amarillo': { value: 4, multiplier: 10000, hex: '#FFFF00', rgb: [255,255,0] },
            'Verde': { value: 5, multiplier: 100000, hex: '#008000', rgb: [0,128,0] },
            'Azul': { value: 6, multiplier: 1000000, hex: '#0000FF', rgb: [0,0,255] },
            'Violeta': { value: 7, multiplier: 10000000, hex: '#8B008B', rgb: [139,0,139] },
            'Gris': { value: 8, multiplier: 100000000, hex: '#808080', rgb: [128,128,128] },
            'Blanco': { value: 9, multiplier: 1000000000, hex: '#FFFFFF', rgb: [255,255,255] },
            'Dorado': { multiplier: 0.1, tolerance: 5, hex: '#FFD700', rgb: [255,215,0] },
            'Plateado': { multiplier: 0.01, tolerance: 10, hex: '#C0C0C0', rgb: [192,192,192] }
        };

        let currentImage = null;
        let markers = [];
        let database = [];
        let history = [];
        let selectedBand = 1;
        let manualBands = {};
        let canvasScale = 1;

        // =========================
        // INICIALIZACI√ìN
        // =========================
        window.onload = function() {
            loadData();
            setupColorGrid();
            updateStats();
            
            // Event listeners
            document.getElementById('photoInput').onchange = handlePhoto;
            document.getElementById('photoCanvas').onclick = canvasClick;
            document.getElementById('photoCanvas').ontouchstart = canvasTouch;
            document.getElementById('trainingCanvas').onclick = trainingClick;
            document.getElementById('trainingCanvas').ontouchstart = trainingTouch;
        };

        // =========================
        // TABS
        // =========================
        function openTab(tabName, element) {
            // Desactivar todos los tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Activar tab seleccionado
            element.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // =========================
        // MODO AN√ÅLISIS
        // =========================
        function handlePhoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    showImage();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function showImage() {
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            // Calcular escala
            const maxWidth = window.innerWidth - 40;
            canvasScale = Math.min(1, maxWidth / currentImage.width);
            
            canvas.width = currentImage.width * canvasScale;
            canvas.height = currentImage.height * canvasScale;
            canvas.style.display = 'block';
            
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            
            // UI updates
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('instructions').classList.add('active');
            document.getElementById('analyzeControls').style.display = 'block';
            document.getElementById('s1').classList.add('active');
            
            markers = [];
            toast('Foto cargada. Toca cada banda de color.', 'success');
        }

        function canvasClick(e) {
            if (!currentImage || markers.length >= 5) return;
            addMarker(e.offsetX, e.offsetY);
        }

        function canvasTouch(e) {
            e.preventDefault();
            if (!currentImage || markers.length >= 5) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left;
            const y = e.touches[0].clientY - rect.top;
            addMarker(x, y);
        }

        function addMarker(x, y) {
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            // Get color
            const imageData = ctx.getImageData(
                Math.max(0, x-5), 
                Math.max(0, y-5), 
                10, 10
            );
            
            let r=0, g=0, b=0, count=0;
            for(let i=0; i<imageData.data.length; i+=4) {
                r += imageData.data[i];
                g += imageData.data[i+1];
                b += imageData.data[i+2];
                count++;
            }
            
            markers.push({
                x: x,
                y: y,
                color: {
                    r: Math.round(r/count),
                    g: Math.round(g/count),
                    b: Math.round(b/count)
                }
            });
            
            drawMarkers();
            updateInstructions();
            
            if(navigator.vibrate) navigator.vibrate(30);
        }

        function drawMarkers() {
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            
            markers.forEach((m, i) => {
                // Circle
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(m.x, m.y, 20, 0, Math.PI * 2);
                ctx.stroke();
                
                // Number
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(i+1, m.x, m.y);
            });
        }

        function updateInstructions() {
            if(markers.length > 0) {
                document.getElementById('s2').classList.add('active');
            }
            if(markers.length >= 3) {
                document.getElementById('s3').classList.add('active');
                document.getElementById('analyzeBtn').disabled = false;
            }
            if(markers.length >= 5) {
                document.getElementById('s4').classList.add('active');
                toast('5 bandas marcadas. Presiona Analizar.', 'info');
            }
        }

        function analyzeResistor() {
            if(markers.length < 3) return;
            
            const colors = markers.map(m => findClosestColor(m.color));
            const result = calculateResistance(colors);
            
            displayResult(result, 'analysisResult');
            addToHistory(result);
        }

        function resetAnalysis() {
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('photoCanvas').style.display = 'none';
            document.getElementById('instructions').classList.remove('active');
            document.getElementById('analyzeControls').style.display = 'none';
            document.getElementById('analysisResult').innerHTML = '';
            document.getElementById('photoInput').value = '';
            
            ['s1','s2','s3','s4'].forEach(id => 
                document.getElementById(id).classList.remove('active')
            );
            
            currentImage = null;
            markers = [];
        }

        // =========================
        // MODO ENTRENAMIENTO
        // =========================
        function startTraining() {
            const value = document.getElementById('knownValue').value;
            if(!value) {
                toast('Ingresa el valor conocido', 'error');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        currentImage = img;
                        showTrainingImage();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function showTrainingImage() {
            const canvas = document.getElementById('trainingCanvas');
            const ctx = canvas.getContext('2d');
            
            const maxWidth = window.innerWidth - 40;
            canvasScale = Math.min(1, maxWidth / currentImage.width);
            
            canvas.width = currentImage.width * canvasScale;
            canvas.height = currentImage.height * canvasScale;
            canvas.style.display = 'block';
            
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            
            document.getElementById('trainingControls').style.display = 'block';
            markers = [];
        }

        function trainingClick(e) {
            if(!currentImage || markers.length >= 5) return;
            trainingAddMarker(e.offsetX, e.offsetY);
        }

        function trainingTouch(e) {
            e.preventDefault();
            if(!currentImage || markers.length >= 5) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left;
            const y = e.touches[0].clientY - rect.top;
            trainingAddMarker(x, y);
        }

        function trainingAddMarker(x, y) {
            const canvas = document.getElementById('trainingCanvas');
            const ctx = canvas.getContext('2d');
            
            const imageData = ctx.getImageData(
                Math.max(0, x-5), 
                Math.max(0, y-5), 
                10, 10
            );
            
            let r=0, g=0, b=0, count=0;
            for(let i=0; i<imageData.data.length; i+=4) {
                r += imageData.data[i];
                g += imageData.data[i+1];
                b += imageData.data[i+2];
                count++;
            }
            
            markers.push({
                color: {
                    r: Math.round(r/count),
                    g: Math.round(g/count),
                    b: Math.round(b/count)
                }
            });
            
            // Draw marker
            ctx.strokeStyle = '#ff00ff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(markers.length, x, y);
            
            if(markers.length >= 3) {
                document.getElementById('saveBtn').disabled = false;
            }
        }

        function saveTraining() {
            if(markers.length < 3) return;
            
            const value = parseFloat(document.getElementById('knownValue').value);
            const unit = parseFloat(document.getElementById('knownUnit').value);
            
            database.push({
                id: Date.now(),
                colors: markers.map(m => m.color),
                value: value * unit,
                confidence: 1
            });
            
            saveData();
            updateStats();
            toast('Patr√≥n guardado exitosamente', 'success');
            
            // Reset
            document.getElementById('trainingCanvas').style.display = 'none';
            document.getElementById('trainingControls').style.display = 'none';
            document.getElementById('knownValue').value = '';
            markers = [];
        }

        // =========================
        // MODO MANUAL
        // =========================
        function setupColorGrid() {
            const grid = document.getElementById('colorGrid');
            grid.innerHTML = '';
            
            Object.entries(colorCodes).forEach(([name, data]) => {
                if(data.value !== undefined) {
                    const btn = document.createElement('div');
                    btn.className = 'color-btn';
                    btn.style.backgroundColor = data.hex;
                    btn.style.color = (data.hex === '#FFFF00' || data.hex === '#FFFFFF') ? '#000' : '#fff';
                    btn.textContent = name;
                    btn.onclick = () => selectColor(name);
                    grid.appendChild(btn);
                }
            });
        }

        function selectBand(num) {
            selectedBand = num;
            document.getElementById('currentBand').textContent = num;
            
            document.querySelectorAll('.band').forEach(b => b.classList.remove('selected'));
            document.querySelector(`[data-band="${num}"]`).classList.add('selected');
        }

        function selectColor(color) {
            manualBands[selectedBand] = color;
            document.querySelector(`[data-band="${selectedBand}"]`).style.backgroundColor = colorCodes[color].hex;
            
            if(selectedBand < 5) {
                selectBand(selectedBand + 1);
            }
        }

        function calculateManual() {
            if(!manualBands[1] || !manualBands[2]) {
                toast('Selecciona al menos 2 bandas', 'error');
                return;
            }
            
            const colors = Object.values(manualBands);
            const result = calculateResistance(colors);
            displayResult(result, 'manualResult');
            addToHistory(result);
        }

        // =========================
        // C√ÅLCULOS
        // =========================
        function findClosestColor(rgb) {
            let minDist = Infinity;
            let closest = 'Negro';
            
            Object.entries(colorCodes).forEach(([name, data]) => {
                const dist = Math.sqrt(
                    Math.pow(rgb.r - data.rgb[0], 2) +
                    Math.pow(rgb.g - data.rgb[1], 2) +
                    Math.pow(rgb.b - data.rgb[2], 2)
                );
                
                if(dist < minDist) {
                    minDist = dist;
                    closest = name;
                }
            });
            
            return closest;
        }

        function calculateResistance(colors) {
            let value = 0;
            let multiplier = 1;
            
            if(colors.length >= 2) {
                value = (colorCodes[colors[0]].value || 0) * 10 + (colorCodes[colors[1]].value || 0);
                if(colors[2]) {
                    multiplier = colorCodes[colors[2]].multiplier || 1;
                }
            }
            
            const resistance = value * multiplier;
            
            return {
                value: resistance,
                formatted: formatValue(resistance),
                colors: colors,
                tolerance: colors[3] ? (colorCodes[colors[3]].tolerance || 20) : 20
            };
        }

        function formatValue(value) {
            if(value >= 1000000) {
                return `${(value/1000000).toFixed(2)} MŒ©`;
            } else if(value >= 1000) {
                return `${(value/1000).toFixed(2)} kŒ©`;
            }
            return `${value.toFixed(2)} Œ©`;
        }

        function displayResult(result, targetId) {
            document.getElementById(targetId).innerHTML = `
                <div class="result">
                    <div class="result-value">${result.formatted}</div>
                    <div>Tolerancia: ¬±${result.tolerance}%</div>
                    <div style="margin-top: 10px;">
                        ${result.colors.map(c => 
                            `<span style="display:inline-block; padding:2px 8px; margin:2px; 
                                    background:${colorCodes[c].hex}; color:${
                                    colorCodes[c].hex === '#FFFF00' || colorCodes[c].hex === '#FFFFFF' ? '#000' : '#fff'
                                    }; border-radius:5px; font-size:0.8em;">${c}</span>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        // =========================
        // BASE DE DATOS
        // =========================
        function loadData() {
            const savedDB = localStorage.getItem('resistorDB');
            if(savedDB) database = JSON.parse(savedDB);
            
            const savedHistory = localStorage.getItem('resistorHistory');
            if(savedHistory) history = JSON.parse(savedHistory);
            
            updateDBInfo();
            updateHistory();
        }

        function saveData() {
            localStorage.setItem('resistorDB', JSON.stringify(database));
            updateDBInfo();
        }

        function updateDBInfo() {
            document.getElementById('dbInfo').textContent = `${database.length} patrones guardados`;
        }

        function exportDB() {
            if(database.length === 0) {
                toast('No hay datos para exportar', 'error');
                return;
            }
            
            const blob = new Blob([JSON.stringify(database, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `resistor_db_${Date.now()}.json`;
            a.click();
        }

        function importDB(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    database = [...database, ...data];
                    saveData();
                    updateStats();
                    toast('Base de datos importada', 'success');
                } catch(err) {
                    toast('Error al importar', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearDB() {
            if(confirm('¬øBorrar toda la base de datos?')) {
                database = [];
                saveData();
                updateStats();
                toast('Base de datos limpiada', 'success');
            }
        }

        // =========================
        // HISTORIAL
        // =========================
        function addToHistory(result) {
            history.unshift({
                ...result,
                timestamp: new Date().toLocaleString('es')
            });
            
            if(history.length > 10) history = history.slice(0, 10);
            
            localStorage.setItem('resistorHistory', JSON.stringify(history));
            updateHistory();
        }

        function updateHistory() {
            const list = document.getElementById('historyList');
            
            if(history.length === 0) {
                list.innerHTML = '<div style="opacity:0.5;">No hay historial</div>';
                return;
            }
            
            list.innerHTML = history.map(h => `
                <div class="history-item">
                    <div>
                        <div class="history-value">${h.formatted}</div>
                        <div style="font-size:0.8em; opacity:0.7;">¬±${h.tolerance}%</div>
                    </div>
                    <div class="history-time">${h.timestamp}</div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if(confirm('¬øLimpiar el historial?')) {
                history = [];
                localStorage.removeItem('resistorHistory');
                updateHistory();
                toast('Historial limpiado', 'success');
            }
        }

        // =========================
        // UTILIDADES
        // =========================
        function updateStats() {
            document.getElementById('patternsCount').textContent = database.length;
            document.getElementById('samplesCount').textContent = database.length;
            
            const accuracy = database.length > 0 ? 
                Math.min(95, 60 + database.length * 2) : 0;
            document.getElementById('accuracyRate').textContent = `${accuracy}%`;
        }

        function toast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>